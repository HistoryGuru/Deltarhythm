<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeff the Mighty Avian - Master Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: black; color: white; overflow: hidden; }
        .soul-heart {
            width: 8px; height: 8px; background-color: #ff0000; position: relative;
            transform: rotate(45deg);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            border: 1px solid #aa0000;
        }
        .soul-heart::before, .soul-heart::after {
            content: ''; position: absolute; width: 8px; height: 8px; background-color: #ff0000; 
            border-radius: 0;
            image-rendering: pixelated;
            clip-path: polygon(0 0, 100% 0, 100% 50%, 50% 100%, 0 50%);
        }
        .soul-heart::before { left: -4px; top: 0; }
        .soul-heart::after { left: 0; top: -4px; }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes rainbow {
            0% { border-color: red; } 33% { border-color: yellow; } 66% { border-color: blue; } 100% { border-color: red; }
        }
        .boss-img { width: 220px; height: auto; image-rendering: pixelated; animation: bounce 2s infinite; transition: all 0.5s; position: relative; z-index: 1; }
        .boss-phase3 { width: 420px !important; }
        .goner { filter: brightness(0) invert(1); animation: goner-fade 2s forwards; }
        @keyframes goner-fade { 0% { opacity: 1; transform: scale(1.5); filter: blur(10px); } 100% { opacity: 0; } }
        
        .rainbow-border { animation: rainbow 2s linear infinite; border-width: 4px; }
        .oboe-body { position: absolute; width: 18px; background: linear-gradient(to bottom, #2d1810 0%, #1a0f08 100%); border-left: 3px solid #8b4513; border-right: 3px solid #8b4513; z-index: 10; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .oboe-bell { position: absolute; width: 28px; height: 14px; background: linear-gradient(to bottom, #1a0f08, #0a0503); border: 2px solid #8b4513; left: -5px; border-radius: 0 0 50% 50%; }
        .oboe-keys { position: absolute; width: 8px; height: 8px; background: silver; border-radius: 50%; left: 50%; transform: translateX(-50%); border: 1px solid #444; }

        .music-note { width: 12px; height: 18px; position: absolute; z-index: 10; }
        .note-head { position: absolute; bottom: 0; left: 0; width: 8px; height: 6px; background: white; border-radius: 50%; }
        .note-stem { position: absolute; bottom: 3px; left: 6px; width: 2px; height: 15px; background: white; }
        
        .ledger-beam { position: absolute; background: rgba(255,255,255,0.9); box-shadow: 0 0 20px white; display: flex; align-items: center; justify-content: space-around; overflow: hidden; }
        .clef-huge { font-size: 28px; font-weight: bold; color: black; pointer-events: none; }
        
        .beam-oboe { 
            position: absolute; 
            width: 40px; 
            height: 40px; 
            background-image: url('https://i.imgur.com/L7Sy9vy.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            image-rendering: pixelated;
            z-index: 15;
        }
        
        .color-beam { position: absolute; width: 45px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: space-around; border-left: 2px solid white; border-right: 2px solid white; }

        @keyframes slash {
            0% { width: 0; opacity: 1; }
            50% { width: 100%; opacity: 1; }
            100% { width: 100%; opacity: 0; }
        }
        @keyframes split-left {
            0% { transform: translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateX(-100px) rotate(-45deg); opacity: 0; }
        }
        @keyframes split-right {
            0% { transform: translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateX(100px) rotate(45deg); opacity: 0; }
        }
        .slash-effect {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: white;
            animation: slash 0.5s ease-out;
            transform-origin: left;
        }
        .mercy-split-left {
            animation: split-left 1s ease-out forwards;
        }
        .mercy-split-right {
            animation: split-right 1s ease-out forwards;
        }

        #flashOverlay { position: fixed; inset: 0; background: white; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.15s; }
        #audioOverlay { position: fixed; inset: 0; background: black; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>
    <div id="flashOverlay"></div>
    <div id="audioOverlay" onclick="startEverything()">
        <div class="text-xl mb-4 text-yellow-400">JEFF THE MIGHTY AVIAN</div>
        <div class="animate-pulse">CLICK TO START</div>
    </div>

    <audio id="bgMusic" loop preload="auto">
        <source src="https://files.catbox.moe/ygh7pb.mp3" type="audio/mpeg">
    </audio>

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div id="gameViewport" class="w-full max-w-3xl">
            <div class="relative w-full flex flex-col items-center mb-4">
                <div id="bossTitle" class="text-[10px] text-gray-500 mb-2">Jeff the Mighty Avian</div>
                <div class="w-64 h-4 bg-red-900 border-2 border-white mb-4">
                    <div id="bossHPBar" class="h-full bg-green-500 transition-all" style="width: 100%"></div>
                </div>
            </div>
            
            <div class="relative w-full flex flex-col items-center mb-8 h-72 justify-end">
                <img id="bossSprite" src="https://imgur.com/Hb10RyW.png" class="boss-img">
            </div>

            <div id="mainBox" class="bg-black border-4 border-white p-8 min-h-[300px] relative flex flex-col justify-center overflow-hidden">
                <div id="boxContent"></div>
            </div>

            <div id="hud" class="mt-8 flex justify-between items-center">
                <div class="text-[12px]">HP <span id="playerHP">20</span>/20 | MERCY <span id="mercyVal">0</span>%</div>
                <div class="flex gap-2">
                    <div id="btn-0" class="px-4 py-2 border-4 border-white cursor-pointer">FIGHT</div>
                    <div id="btn-1" class="px-4 py-2 border-4 border-white cursor-pointer">ACT</div>
                    <div id="btn-2" class="px-4 py-2 border-4 border-white cursor-pointer">ITEM</div>
                    <div id="btn-3" class="px-4 py-2 border-4 border-white cursor-pointer">MERCY</div>
                </div>
            </div>
        </div>
    </div>

    <button id="devP3Btn" class="fixed bottom-4 right-4 opacity-30 hover:opacity-100 text-[10px] bg-red-900 p-2 rounded">SKIP TO P3</button>
    <button id="devP2Btn" class="fixed bottom-4 right-32 opacity-30 hover:opacity-100 text-[10px] bg-yellow-700 p-2 rounded">SKIP TO P2</button>

    <script>
        let gameState = 'intro';
        let hp = 20, bossHP = 5000, mercy = 0, currentPhase = 1, patternIdx = 0;
        let typedText = "", isTyping = false, typeTimer = null, fullText = '';
        let introLines = ["It's a beautiful day outside.", "The sun is shining...", "Birds are singing...", "Kids like you...", "Should be practicing your oboe."];
        let attacks = [], p3Oboes = [], beams = [], colorBeams = [];
        let playerPos = { x: 50, y: 50 }, prevPos = { x: 50, y: 50 };
        const keys = {};
        let frameCount = 0;
        let lastBeamTime = 0;
        let selectedAction = 0;
        let selectedSubAction = 0;
        let currentTextSound = null;

        function startEverything() {
            document.getElementById('audioOverlay').style.display = 'none';
            document.getElementById('bgMusic').play();
            advanceIntro();
            requestAnimationFrame(gameLoop);
        }

        function triggerFlash() {
            const flash = document.getElementById('flashOverlay');
            flash.style.opacity = "1";
            setTimeout(() => { flash.style.opacity = "0"; }, 150);
        }

        function advanceIntro() {
            if (introLines.length > 0) {
                startTyping(introLines.shift());
            } else {
                gameState = 'action';
                selectedAction = 0;
                updateButtonStyles();
                document.getElementById('boxContent').innerHTML = `<div class="text-lg">* Jeff stares intently.</div>`;
            }
        }

        function startTyping(text, callback) {
            isTyping = true; typedText = ""; let i = 0;
            clearInterval(typeTimer);
            
            // Stop any previous text sound
            if (currentTextSound) {
                currentTextSound.pause();
                currentTextSound = null;
            }
            
            // Create and start new text sound
            currentTextSound = new Audio('https://files.catbox.moe/4lc1rc.mp3');
            currentTextSound.volume = 0.75;
            currentTextSound.loop = true;
            currentTextSound.play().catch(e => {});
            
            typeTimer = setInterval(() => {
                typedText += text[i]; i++;
                document.getElementById('boxContent').innerHTML = `<div class="text-lg">${typedText}</div>`;
                
                if (i >= text.length) { 
                    clearInterval(typeTimer); 
                    isTyping = false;
                    
                    // Stop the text sound when typing finishes
                    if (currentTextSound) {
                        currentTextSound.pause();
                        currentTextSound = null;
                    }
                    
                    if(callback) callback(); 
                }
            }, 30);
        }

        function enterMenu() {
            gameState = 'action';
            selectedAction = 0;
            updateButtonStyles();
            document.getElementById('boxContent').innerHTML = `<div class="text-lg">* Jeff stares intently.</div>`;
        }

        function updateButtonStyles() {
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`btn-${i}`);
                if (btn) {
                    btn.style.borderColor = (i === selectedAction) ? '#facc15' : 'white';
                    btn.style.color = (i === selectedAction) ? '#facc15' : 'white';
                }
            }
        }

        function handleAction() {
            if (selectedAction === 0) {
                startFight();
            } else {
                gameState = 'subaction';
                selectedSubAction = 0;
                updateSubMenu();
            }
        }

        function handleSubAction() {
            gameState = 'message';
            
            if (selectedAction === 1) {
                if (selectedSubAction === 0) {
                    startTyping(`* Jeff the Mighty Avian - HP ${bossHP}/5000. A proud bird who values musical excellence.`);
                } else if (selectedSubAction === 1) {
                    mercy += 10;
                    startTyping("* You complimented Jeff's feathers. Mercy increased!");
                } else if (selectedSubAction === 2) {
                    mercy += 5;
                    startTyping("* You sang a melody. Jeff seems pleased.");
                } else {
                    startTyping("* You mocked Jeff. He looks annoyed.");
                }
            } else if (selectedAction === 2) {
                if (selectedSubAction === 0) {
                    hp = Math.min(20, hp + 10);
                    startTyping("* You ate some bird seed. HP restored!");
                } else {
                    startTyping("* You rang the tuning fork. Nothing happened.");
                }
            } else if (selectedAction === 3) {
                // MERCY - Always rejected with dramatic effect
                gameState = 'nomercy';
                triggerMercySlash();
                // Show NO MERCY instantly without typing animation
                document.getElementById('boxContent').innerHTML = `<div class="text-lg">* NO MERCY!<div class="text-xs mt-4 text-gray-400">Press Z to return</div></div>`;
                return;
            }
        }

        function triggerMercySlash() {
            // Flash effect
            triggerFlash();
            
            // Get mercy display safely
            const mercyElement = document.getElementById('mercyVal');
            if (!mercyElement) return;
            
            const mercyDisplay = mercyElement.parentElement;
            if (!mercyDisplay) return;
            
            // Add slash effect
            const slash = document.createElement('div');
            slash.style.position = 'absolute';
            slash.style.width = '100%';
            slash.style.height = '2px';
            slash.style.background = 'white';
            slash.style.top = '50%';
            slash.style.left = '0';
            slash.style.zIndex = '1000';
            slash.style.animation = 'slash 0.3s ease-out';
            
            mercyDisplay.style.position = 'relative';
            mercyDisplay.appendChild(slash);
            
            // Split and decay mercy text
            setTimeout(() => {
                const leftHalf = document.createElement('span');
                const rightHalf = document.createElement('span');
                
                leftHalf.textContent = 'MERC';
                rightHalf.textContent = 'Y ' + mercy + '%';
                
                leftHalf.style.display = 'inline-block';
                leftHalf.style.animation = 'split-left 1s ease-out forwards';
                
                rightHalf.style.display = 'inline-block';
                rightHalf.style.animation = 'split-right 1s ease-out forwards';
                
                // Store original content
                const hpDisplay = document.getElementById('playerHP');
                const originalMercyText = 'HP ' + Math.ceil(hp) + '/20 | MERCY ' + mercy + '%';
                
                // Clear and add split halves
                mercyDisplay.innerHTML = 'HP <span id="playerHP">' + Math.ceil(hp) + '</span>/20 | ';
                mercyDisplay.appendChild(leftHalf);
                mercyDisplay.appendChild(rightHalf);
                
                // Clean up after animation
                setTimeout(() => {
                    mercyDisplay.innerHTML = 'HP <span id="playerHP">' + Math.ceil(hp) + '</span>/20 | MERCY <span id="mercyVal">' + mercy + '</span>%';
                }, 1000);
            }, 300);
        }

        function updateSubMenu() {
            const options = selectedAction === 1 ? ['Check', 'Compliment', 'Sing', 'Mock'] : selectedAction === 2 ? ['Bird Seed', 'Tuning Fork'] : ['Spare', 'Flee'];
            document.getElementById('boxContent').innerHTML = `<div class="grid grid-cols-2 gap-4 text-xl">${options.map((opt, i) => `<div class="${selectedSubAction === i ? 'text-yellow-400' : 'text-white'}">* ${opt}</div>`).join('')}</div>`;
        }

        function startFight() {
            gameState = 'fight';
            let barPos = 0;
            const fightLoop = () => {
                if(gameState !== 'fight') return;
                barPos = (barPos + 4.5) % 100;
                document.getElementById('boxContent').innerHTML = `
                    <div class="relative w-full h-24 bg-black border-4 border-white overflow-hidden">
                        <div class="absolute left-[25%] w-[50%] h-full bg-red-600 border-x-2 border-white"></div>
                        <div class="absolute left-[35%] w-[30%] h-full bg-yellow-500 border-x-2 border-white"></div>
                        <div class="absolute left-[47%] w-[6%] h-full bg-green-500 border-x-2 border-white"></div>
                        <div class="absolute top-0 w-3 h-full bg-white shadow-[0_0_15px_white]" style="left:${barPos}%"></div>
                    </div>`;
                requestAnimationFrame(fightLoop);
            };
            fightLoop();
            
            const handleFight = (e) => {
                if (gameState === 'fight' && (e.key === ' ' || e.key === 'Enter')) {
                    window.removeEventListener('keydown', handleFight);
                    let dmg = (barPos > 47 && barPos < 53) ? 400 : (barPos > 35 && barPos < 65) ? 250 : 100;
                    bossHP = Math.max(0, bossHP - dmg);
                    updateBossUI();
                    gameState = 'message';
                    
                    if (bossHP <= 0) {
                        gameState = 'victory';
                        document.getElementById('bossSprite').classList.add('goner');
                        document.getElementById('boxContent').innerHTML = `<div class="text-center">
                            <div class="text-yellow-400 text-3xl mb-4">VICTORY!</div>
                            <div class="text-lg">* You defeated Jeff the Mighty Avian.</div>
                            <div class="text-sm mt-4 text-gray-400">Reloading...</div>
                        </div>`;
                        setTimeout(() => location.reload(), 5000);
                    } else if (bossHP <= 2500 && currentPhase < 3) {
                        currentPhase = 3; patternIdx = 0;
                        triggerFlash();
                        document.getElementById('bossSprite').src = "https://imgur.com/heB0IRZ.png";
                        document.getElementById('bossSprite').classList.add('boss-phase3');
                        document.getElementById('mainBox').classList.add('rainbow-border');
                        startTyping("Perish Fool!", () => setTimeout(startDodge, 1500));
                    } else if (bossHP <= 3750 && currentPhase < 2) {
                        currentPhase = 2; patternIdx = 0;
                        triggerFlash();
                        document.getElementById('bossSprite').src = "https://imgur.com/9cxx6Yt.png";
                        startTyping("Music is the Joy of our Souls", () => setTimeout(startDodge, 1500));
                    } else {
                        // Cycle through attacks with specific quotes
                        patternIdx++;
                        let quote = "";
                        
                        if (currentPhase === 1) {
                            if (patternIdx % 2 === 0) {
                                quote = "* Double Reeds are the highest of instruments.";
                            } else {
                                quote = "* Keep practicing...";
                            }
                        } else if (currentPhase === 2) {
                            let p2Pattern = patternIdx % 3;
                            if (p2Pattern === 0) {
                                quote = "* Without music, life would be a mistake.";
                            } else if (p2Pattern === 1) {
                                quote = "* Feel the rhythm of the ledgers!";
                            } else {
                                quote = "* Stay in tune with the colors!";
                            }
                        } else if (currentPhase === 3) {
                            if (patternIdx % 2 === 0) {
                                quote = "* Perish Fool!";
                            } else {
                                quote = "* Music is the ultimate weapon!";
                            }
                        }
                        
                        startTyping(quote, () => setTimeout(startDodge, 1000));
                    }
                }
            };
            window.addEventListener('keydown', handleFight);
        }

        function updateBossUI() {
            const bossHPBar = document.getElementById('bossHPBar');
            if (bossHPBar) {
                bossHPBar.style.width = (bossHP/5000)*100 + "%";
            }
        }

        function startDodge() {
            // Completely stop any ongoing dodge mechanics first
            if (gameState === 'dodge') {
                console.log("WARNING: startDodge called while already in dodge state!");
                return; // Prevent double-calling
            }
            
            console.log("Starting dodge phase. Pattern:", patternIdx, "Phase:", currentPhase);
            
            gameState = 'dodge';
            // Clear ALL attacks when starting dodge phase
            attacks = []; 
            p3Oboes = []; 
            beams = []; 
            colorBeams = [];
            
            // Spawn player at bottom corner for Phase 3 ring attack, center for others
            if (currentPhase === 3 && patternIdx % 2 === 1) {
                playerPos = { x: 15, y: 85 }; // Bottom left corner
                ringGapRotation = 0;
            } else {
                playerPos = { x: 50, y: 50 }; // Center
            }
            
            frameCount = 0;
            lastBeamTime = 0;
            
            setTimeout(() => { 
                if(gameState === 'dodge') {
                    console.log("Ending dodge phase, transitioning to menu");
                    // Clear attacks again before transitioning
                    attacks = [];
                    p3Oboes = [];
                    beams = [];
                    colorBeams = [];
                    
                    gameState = 'action';
                    selectedAction = 0;
                    updateButtonStyles();
                    document.getElementById('boxContent').innerHTML = `<div class="text-lg">* Jeff stares intently.</div>`;
                }
            }, 9000);
        }

        function devP3() { triggerFlash(); bossHP = 1250; updateBossUI(); currentPhase = 3; patternIdx = 0; document.getElementById('bossSprite').src = "https://imgur.com/heB0IRZ.png"; document.getElementById('bossSprite').classList.add('boss-phase3'); document.getElementById('mainBox').classList.add('rainbow-border'); enterMenu(); }

        function devP2() { triggerFlash(); bossHP = 3750; updateBossUI(); currentPhase = 2; patternIdx = 0; document.getElementById('bossSprite').src = "https://imgur.com/9cxx6Yt.png"; enterMenu(); }

        function gameLoop(t) {
            // Only update dodge mechanics when in dodge state
            if (gameState === 'dodge') {
                updateDodge(t);
                renderDodge();
            }
            // Always update HUD (unless in gameover/victory)
            if (gameState !== 'gameover' && gameState !== 'victory') {
                const playerHPEl = document.getElementById('playerHP');
                const mercyValEl = document.getElementById('mercyVal');
                if (playerHPEl) playerHPEl.innerText = Math.ceil(hp);
                if (mercyValEl) mercyValEl.innerText = mercy;
            }
            requestAnimationFrame(gameLoop);
        }

        function updateDodge(t) {
            // Only update if we're actually in dodge state
            if (gameState !== 'dodge') {
                return;
            }
            
            frameCount++;
            prevPos = {...playerPos};
            if ((keys['a'] || keys['arrowleft']) && playerPos.x > 5) playerPos.x -= 1.3;
            if ((keys['d'] || keys['arrowright']) && playerPos.x < 95) playerPos.x += 1.3;
            if ((keys['w'] || keys['arrowup']) && playerPos.y > 5) playerPos.y -= 1.3;
            if ((keys['s'] || keys['arrowdown']) && playerPos.y < 95) playerPos.y += 1.3;
            
            let moving = Math.abs(playerPos.x - prevPos.x) > 0.1 || Math.abs(playerPos.y - prevPos.y) > 0.1;

            // Only spawn new attacks in dodge state
            if (gameState !== 'dodge') {
                return;
            }

            // Spawn attacks based on current phase and pattern
            if (currentPhase === 3) {
                let p3Mode = patternIdx % 2;
                if (p3Mode === 1) {
                    // Continuously fire rings with gaps - every 25 frames with VERY slow movement
                    if (frameCount % 25 === 0) { 
                        // Spawn 16 clefs in a circle (skipping 2 for a gap)
                        for(let i=0; i<16; i++) {
                            // Skip two positions to create a gap
                            let skipPos1 = ringGapRotation % 16;
                            let skipPos2 = (ringGapRotation + 1) % 16;
                            
                            if (i !== skipPos1 && i !== skipPos2) {
                                attacks.push({
                                    x: 50, 
                                    y: 50, 
                                    vx: Math.cos(i*Math.PI/8)*1.2, 
                                    vy: Math.sin(i*Math.PI/8)*1.2, 
                                    type: 'clef'
                                });
                            }
                        }
                        // Rotate gap position for next ring
                        ringGapRotation += 2;
                    }
                } else {
                    // Oboe rush
                    if (frameCount % 2 === 0) {
                        let center = Math.sin(frameCount/30)*50 + 100;
                        p3Oboes.push({x: 100, h: center - 55, top: true});
                        p3Oboes.push({x: 100, h: 320 - (center + 55), top: false});
                    }
                }
            } else if (currentPhase === 2) {
                let p2Mode = patternIdx % 3;
                if (p2Mode === 0) {
                    if (Math.random() < 0.22) attacks.push({x: 100, y: Math.random()*100, vx: -4.6, vy: 0, type:'note'});
                } else if (p2Mode === 1) {
                    if (frameCount - lastBeamTime > 60) {
                        let beam = Math.random() > 0.5 
                            ? {x: Math.random()*80, y: 0, w: 22, h: 100, active: false} 
                            : {x: 0, y: Math.random()*80, w: 100, h: 22, active: false};
                        beams.push(beam);
                        setTimeout(() => beam.active = true, 500);
                        setTimeout(() => beams = beams.filter(b => b !== beam), 900);
                        lastBeamTime = frameCount;
                    }
                } else {
                    if (frameCount % 50 === 0) colorBeams.push({x: 100, type: Math.random() > 0.5 ? 'blue' : 'orange'});
                }
            } else {
                let p1Mode = patternIdx % 2;
                if (p1Mode === 0) {
                    if (Math.random() < 0.06) attacks.push({x: Math.random()*100, y:0, vx:0, vy:1.6, type:'feather'});
                } else {
                    if (Math.random() < 0.08) {
                        let side = Math.random() > 0.5 ? 0 : 100;
                        attacks.push({x: side, y: Math.random()*100, vx: side === 0 ? 1.6 : -1.6, vy: (50 - (Math.random()*100))/40, type:'pellet'});
                    }
                }
            }

            p3Oboes.forEach(o => o.x -= 3.5);
            p3Oboes = p3Oboes.filter(o => o.x > -10);

            colorBeams.forEach(cb => cb.x -= 2.8);
            colorBeams = colorBeams.filter(cb => cb.x > -10);

            attacks.forEach((a, idx) => {
                a.x += a.vx; a.y += a.vy;
                if (Math.hypot(a.x - playerPos.x, a.y - playerPos.y) < 5) {
                    hp -= 0.35;
                }
            });

            beams.forEach(b => {
                if (b.active && playerPos.x >= b.x && playerPos.x <= b.x + b.w && 
                    playerPos.y >= b.y && playerPos.y <= b.y + b.h && !b.hit) {
                    b.hit = true;
                    hp -= 0.6;
                }
            });

            colorBeams.forEach(cb => {
                if (Math.abs(cb.x - playerPos.x) < 8 && !cb.hit) {
                    if (cb.type === 'blue' && moving) {
                        cb.hit = true;
                        hp -= 0.4;
                    } else if (cb.type === 'orange' && !moving) {
                        cb.hit = true;
                        hp -= 0.4;
                    }
                }
            });

            if (currentPhase === 3 && (patternIdx % 2 === 0)) {
                let py = (playerPos.y/100)*320;
                p3Oboes.forEach(o => {
                    if (Math.abs(o.x - playerPos.x) < 5) {
                        if ((o.top && py < o.h) || (!o.top && py > 320 - o.h)) hp -= 0.5;
                    }
                });
            }
            
            // Check for death
            if (hp <= 0) {
                gameState = 'gameover';
                document.getElementById('boxContent').innerHTML = `<div class="text-center text-red-600 text-3xl animate-pulse">GAME OVER</div>`;
                setTimeout(() => location.reload(), 3000);
            }
        }

        function renderDodge() {
            let html = `<div class="relative w-80 h-80 border-4 border-white mx-auto overflow-hidden bg-black">
                <div class="absolute" style="left:${playerPos.x}%; top:${playerPos.y}%; transform:translate(-50%,-50%); z-index:100;"><div class="soul-heart"></div></div>
                ${attacks.map(a => {
                    if (a.type === 'note') {
                        return `<div class="music-note" style="left:${a.x}%; top:${a.y}%; transform:translate(-50%,-50%);"><div class="note-head"></div><div class="note-stem"></div></div>`;
                    } else if (a.type === 'clef') {
                        return `<div class="absolute text-white text-xl" style="left:${a.x}%; top:${a.y}%; transform:translate(-50%,-50%)">\u{1D11E}</div>`;
                    } else if (a.type === 'feather') {
                        return `<div class="absolute text-white" style="left:${a.x}%; top:${a.y}%; transform:translate(-50%,-50%)">|</div>`;
                    } else {
                        return `<div class="absolute text-white" style="left:${a.x}%; top:${a.y}%; transform:translate(-50%,-50%)">â€¢</div>`;
                    }
                }).join('')}
                ${beams.map(b => {
                    let isHorizontal = b.w > b.h;
                    return `<div class="ledger-beam" style="left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; opacity:${b.active ? 1 : 0.3};">
                        ${b.active ? '<span class="clef-huge">\u{1D11E}</span><span class="clef-huge">\u{1D11E}</span>' : ''}
                    </div>`;
                }).join('')}
                ${colorBeams.map(cb => `<div class="color-beam" style="left:${cb.x}%; transform:translateX(-50%); background:${cb.type === 'blue' ? 'rgba(0,191,255,0.7)' : 'rgba(255,165,0,0.7)'};"><span class="clef-huge" style="color:${cb.type === 'blue' ? '#00BFFF' : '#FFA500'}">\u{1D11E}</span></div>`).join('')}
                ${p3Oboes.map(o => {
                    let style = o.top ? `top:0; height:${o.h}px;` : `bottom:0; height:${o.h}px;`;
                    let keys = o.top 
                        ? `<div class="oboe-keys" style="top:20%"></div><div class="oboe-keys" style="top:40%"></div><div class="oboe-keys" style="top:60%"></div>`
                        : `<div class="oboe-keys" style="bottom:20%"></div><div class="oboe-keys" style="bottom:40%"></div><div class="oboe-keys" style="bottom:60%"></div>`;
                    return `<div class="oboe-body" style="left:${o.x}%; ${style}">
                        <div class="oboe-bell" style="${o.top?'bottom:-8px':'top:-8px'}"></div>
                        ${keys}
                    </div>`;
                }).join('')}
            </div>
            ${beams.map(b => {
                let isHorizontal = b.w > b.h;
                let oboeHTML = '';
                if (isHorizontal) {
                    // Horizontal beam - oboe on left side, OUTSIDE the box
                    let topPos = 160 + (b.y * 3.2); // Convert % to pixels (320px box)
                    oboeHTML = `<div class="beam-oboe" style="position:absolute; left:-45px; top:${topPos}px; transform:translateY(-50%);"></div>`;
                } else {
                    // Vertical beam - oboe on top, OUTSIDE the box, rotated 90 degrees
                    let leftPos = (b.x * 3.2); // Convert % to pixels
                    oboeHTML = `<div class="beam-oboe" style="position:absolute; top:-45px; left:${leftPos}px; transform:translateX(-50%) rotate(90deg);"></div>`;
                }
                return oboeHTML;
            }).join('')}`;
            document.getElementById('boxContent').innerHTML = html;
        }

        window.onkeydown = e => { 
            keys[e.key.toLowerCase()] = true; 
            const key = e.key.toLowerCase();
            
            if (key === ' ' || key === 'enter') {
                if (isTyping) {
                    // Skip typing animation
                    skipTyping = true;
                }
                else if (gameState === 'intro' && introLines.length > 0) {
                    advanceIntro();
                }
                else if (gameState === 'intro') {
                    advanceIntro();
                }
                else if (gameState === 'message') {
                    startDodge();
                }
                else if (gameState === 'action') {
                    handleAction();
                }
                else if (gameState === 'subaction') {
                    handleSubAction();
                }
            }
            
            if (gameState === 'action') {
                if (key === 'a' || key === 'arrowleft') {
                    selectedAction = (selectedAction + 3) % 4;
                    updateButtonStyles();
                }
                if (key === 'd' || key === 'arrowright') {
                    selectedAction = (selectedAction + 1) % 4;
                    updateButtonStyles();
                }
            }
            
            if (gameState === 'subaction') {
                if (key === 'w' || key === 'arrowup') {
                    selectedSubAction = (selectedSubAction + 3) % 4;
                    if (selectedAction === 2 && selectedSubAction > 1) selectedSubAction = 0;
                    if (selectedAction === 3 && selectedSubAction > 1) selectedSubAction = 0;
                    updateSubMenu();
                }
                if (key === 's' || key === 'arrowdown') {
                    selectedSubAction = (selectedSubAction + 1) % 4;
                    if (selectedAction === 2 && selectedSubAction > 1) selectedSubAction = 0;
                    if (selectedAction === 3 && selectedSubAction > 1) selectedSubAction = 0;
                    updateSubMenu();
                }
                if (key === 'a' || key === 'arrowleft') {
                    selectedSubAction = selectedSubAction === 0 ? 1 : selectedSubAction === 2 ? 3 : selectedSubAction - 1;
                    if (selectedAction === 2 && selectedSubAction > 1) selectedSubAction = 1;
                    if (selectedAction === 3 && selectedSubAction > 1) selectedSubAction = 1;
                    updateSubMenu();
                }
                if (key === 'd' || key === 'arrowright') {
                    selectedSubAction = selectedSubAction === 1 ? 0 : selectedSubAction === 3 ? 2 : selectedSubAction + 1;
                    if (selectedAction === 2 && selectedSubAction > 1) selectedSubAction = 0;
                    if (selectedAction === 3 && selectedSubAction > 1) selectedSubAction = 0;
                    updateSubMenu();
                }
                if (key === 'z') {
                    enterMenu();
                }
            }
            
            if (gameState === 'nomercy') {
                if (key === 'z') {
                    enterMenu();
                }
            }
        };
        
        window.onkeyup = e => keys[e.key.toLowerCase()] = false;
        
        // Setup button click handlers after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('devP3Btn').addEventListener('click', devP3);
            document.getElementById('devP2Btn').addEventListener('click', devP2);
        });
    </script>
</body>
</html>
